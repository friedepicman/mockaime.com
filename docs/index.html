<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <meta name="description" content="Generate realistic AIME mock tests with customizable difficulty levels. Practice for the American Invitational Mathematics Examination with 3000+ non-AIME problems.">
  <meta name="keywords" content="AIME, AIME practice, mock AIME, AIME problems, math competition, AMC preparation">
  <meta name="author" content="Mock AIME Generator">
  <title>Mock AIME Generator - Practice Tests for AIME</title>
  <meta property="og:title" content="Mock AIME Generator">
  <meta property="og:description" content="Generate realistic AIME mock tests with customizable difficulty levels">
  <meta property="og:url" content="https://mockaime.com">
  <meta property="og:type" content="website">

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.50.4/dist/umd/supabase.min.js"></script>

  <script>
    const SUPABASE_URL = 'https://ftdbplxkyaocyrjpmjyb.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZ0ZGJwbHhreWFvY3lyanBtanliIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTIxMDgxMDUsImV4cCI6MjA2NzY4NDEwNX0.hE0V09JxdLYNbZqPVH3HZxNpLPP2rXIaBsNGUHO3upc';

    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    async function loadProblemsFromSupabase() {
      let allProblems = [];
      let from = 0;
      const chunkSize = 1000;
      let done = false;

      while (!done) {
        const { data, error } = await supabaseClient
          .from('problems')
          .select('*')
          .range(from, from + chunkSize - 1);

        if (error) {
          console.error('Error fetching problems:', error);
          alert('Failed to load problems from database.');
          return [];
        }

        if (data.length === 0) {
          done = true;
        } else {
          allProblems.push(...data);
          from += chunkSize;
        }
      }

      console.log('Loaded', allProblems.length, 'problems from Supabase');
      return allProblems;
    }

    let allProblems = [];
    let chosenProblems = [];
    let problemsLoaded = false;

    window.onload = async () => {
      updateButtonStates();
      allProblems = await loadProblemsFromSupabase();
      problemsLoaded = true;
      updateButtonStates();
    };

    function updateButtonStates() {
      const generateBtn = document.getElementById('generateBtn');
      const checkBtn = document.getElementById('checkBtn');
      
      if (problemsLoaded) {
        generateBtn.disabled = false;
        checkBtn.disabled = false;
        generateBtn.style.opacity = '1';
        checkBtn.style.opacity = '1';
        generateBtn.style.cursor = 'pointer';
        checkBtn.style.cursor = 'pointer';
      } else {
        generateBtn.disabled = true;
        checkBtn.disabled = true;
        generateBtn.style.opacity = '0.5';
        checkBtn.style.opacity = '0.5';
        generateBtn.style.cursor = 'not-allowed';
        checkBtn.style.cursor = 'not-allowed';
      }
    }
  </script>

  <style>
    /* ===== IMPROVED STYLES START HERE ===== */
    
    /* Base styles with better typography */
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
      margin: 0;
      padding: 0;
      background: linear-gradient(to bottom, #f8f9fa 0%, #e9ecef 100%);
      font-size: 16px;
      line-height: 1.6;
      color: #212529;
    }
    
    h1 {
      text-align: center;
      color: #004488;
      font-weight: 700;
      font-size: 2.5rem;
      margin-bottom: 0.5rem;
    }
    
    /* Improved navbar with gradient */
    nav {
      background: linear-gradient(135deg, #004488 0%, #0066cc 100%);
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      margin-bottom: 48px;
    }
    
    nav a {
      color: white;
      text-decoration: none;
      padding: 20px 24px;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      display: inline-block;
      font-weight: 500;
    }
    
    nav a:hover {
      background: rgba(255,255,255,0.15);
      border-radius: 4px;
    }
    
    /* Improved buttons with better hover states */
    select, button {
      font-size: 16px;
      padding: 12px 20px;
      margin: 8px 5px;
      border-radius: 8px;
      border: 1px solid #dee2e6;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      font-weight: 500;
    }
    
    button {
      background: linear-gradient(135deg, #004488 0%, #0066cc 100%);
      color: white;
      border: none;
      cursor: pointer;
      box-shadow: 0 2px 4px rgba(0,68,136,0.2);
    }
    
    button:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,68,136,0.3);
    }
    
    button:active:not(:disabled) {
      transform: translateY(0);
    }
    
    button:disabled {
      cursor: not-allowed;
      opacity: 0.5;
    }
    
    select {
      background: white;
      cursor: pointer;
    }
    
    select:focus {
      outline: none;
      border-color: #0066cc;
      box-shadow: 0 0 0 3px rgba(0,102,204,0.1);
    }
    
    /* Improved problem cards with hover effect */
    .problem {
      background: white;
      padding: 24px;
      padding-top: 48px;
      margin: 20px 0;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      border: 1px solid #e9ecef;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
    }
    
    .problem:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 16px rgba(0,0,0,0.12);
      border-color: #0066cc;
    }
    
    /* Better answer input styling - MADE SMALLER */
    .answer {
      margin-top: 16px;
      margin-bottom: 12px;
    }
    
    input[type="text"] {
      padding: 8px 12px;
      font-size: 16px;
      width: 80px;
      border: 2px solid #dee2e6;
      border-radius: 8px;
      transition: all 0.2s;
      font-weight: 500;
      text-align: center;
    }
    
    input[type="text"]:focus {
      outline: none;
      border-color: #0066cc;
      box-shadow: 0 0 0 4px rgba(0,102,204,0.1);
    }
    
    /* Improved stats section */
    .stats {
      margin: 0 0 16px 0;
      font-size: 15px;
      color: #495057;
    }
    
    .stats:empty {
      display: none;
    }
    
    /* Better result indicators */
    .result {
      display: inline-block;
      margin-left: 12px;
      font-size: 20px;
      font-weight: 700;
    }
    
    .correct {
      color: #28a745;
    }
    
    .incorrect {
      color: #dc3545;
    }
    
    /* Improved difficulty badge */
    .difficulty-indicator {
      display: inline-block;
      background: linear-gradient(135deg, #e9ecef 0%, #dee2e6 100%);
      padding: 4px 12px;
      border-radius: 6px;
      font-size: 13px;
      margin-left: 12px;
      color: #495057;
      font-weight: 600;
    }
    
    /* Enhanced summary section */
    #summary {
      margin: 24px 0;
      padding: 24px;
      background: white;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      border: 1px solid #e9ecef;
    }
    
    .summary-header {
      font-size: 24px;
      font-weight: 700;
      color: #004488;
      margin-bottom: 20px;
    }
    
    /* Improved problem grid */
    .problem-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(50px, 1fr));
      gap: 12px;
      max-width: 650px;
    }
    
    .problem-indicator {
      width: 50px;
      height: 50px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 18px;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      border: 2px solid transparent;
      cursor: default;
    }
    
    .problem-indicator:hover {
      transform: scale(1.1);
    }
    
    .problem-indicator.unanswered {
      background: #f8f9fa;
      color: #adb5bd;
      border-color: #dee2e6;
    }
    
    .problem-indicator.correct {
      background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
      color: #155724;
      border-color: #28a745;
      box-shadow: 0 2px 4px rgba(40,167,69,0.2);
    }
    
    .problem-indicator.incorrect {
      background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%);
      color: #721c24;
      border-color: #dc3545;
      box-shadow: 0 2px 4px rgba(220,53,69,0.2);
    }
    
    .problem-indicator.override {
      background: linear-gradient(135deg, #d1ecf1 0%, #bee5eb 100%);
      color: #0c5460;
      border-color: #17a2b8;
      box-shadow: 0 2px 4px rgba(23,162,184,0.2);
    }
    
    /* Improved status icons */
    .status-icon {
      position: absolute;
      top: 16px;
      right: 16px;
      font-size: 32px;
      font-weight: 700;
      opacity: 0.9;
    }
    
    .status-icon.correct {
      color: #28a745;
    }
    
    .status-icon.incorrect {
      color: #dc3545;
    }
    
    .status-icon.override {
      color: #17a2b8;
    }
    
    .status-icon.unanswered {
      color: #adb5bd;
    }
    
    /* Better button styling */
    .replace-button, .report-button {
      display: inline-block;
      margin-top: 12px;
      padding: 8px 16px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    .replace-button {
      background: #6c757d;
      color: white;
      margin-right: 8px;
    }
    
    .replace-button:hover {
      background: #5a6268;
      transform: translateY(-1px);
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    
    .report-button {
      background: #ffe69c;
      color: #000;
    }
    
    .report-button:hover {
      background: #ffd43b;
      transform: translateY(-1px);
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }

    /* NEW: Invisible AoPS link button in top right */
    .aops-link-top {
      position: absolute;
      top: 16px;
      right: 16px;
      color: #004488;
      text-decoration: none;
      font-size: 14px;
      font-weight: 500;
      padding: 6px 12px;
      border-radius: 6px;
      transition: all 0.2s;
      background: transparent;
    }
    
    .aops-link-top:hover {
      background: #f8f9fa;
      color: #0066cc;
    }
    
    /* Improved modal */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
      backdrop-filter: blur(4px);
    }
    
    .modal-content {
      background-color: white;
      margin: 10% auto;
      padding: 32px;
      border-radius: 12px;
      width: 90%;
      max-width: 500px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.3);
      animation: modalSlideIn 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    @keyframes modalSlideIn {
      from {
        transform: translateY(-20px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }
    
    .modal-header {
      font-size: 22px;
      font-weight: 700;
      margin-bottom: 24px;
      color: #004488;
    }
    
    .modal-close {
      float: right;
      font-size: 28px;
      font-weight: 700;
      cursor: pointer;
      color: #adb5bd;
      transition: color 0.2s;
    }
    
    .modal-close:hover {
      color: #495057;
    }
    
    .modal-label {
      display: block;
      margin: 16px 0 8px 0;
      font-weight: 600;
      color: #495057;
    }
    
    .modal-select, .modal-textarea {
      width: 100%;
      padding: 10px 12px;
      border: 2px solid #dee2e6;
      border-radius: 8px;
      font-family: inherit;
      font-size: 15px;
      transition: border-color 0.2s;
    }
    
    .modal-select:focus, .modal-textarea:focus {
      outline: none;
      border-color: #0066cc;
      box-shadow: 0 0 0 3px rgba(0,102,204,0.1);
    }
    
    .modal-textarea {
      min-height: 100px;
      resize: vertical;
    }
    
    .modal-submit {
      margin-top: 24px;
      padding: 12px 24px;
      background: linear-gradient(135deg, #004488 0%, #0066cc 100%);
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      font-weight: 600;
      width: 100%;
      transition: all 0.2s;
    }
    
    .modal-submit:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,68,136,0.3);
    }
    
    .modal-submit:disabled {
      background: #adb5bd;
      cursor: not-allowed;
      transform: none;
    }
    
    /* Improved checkbox styling */
    label {
      cursor: pointer;
      user-select: none;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      font-weight: 500;
    }
    
    input[type="checkbox"] {
      cursor: pointer;
      width: 18px;
      height: 18px;
    }
    
    .mode-toggle {
      margin: 16px 0 24px 0;
      padding: 16px;
      background: #f8f9fa;
      border-radius: 8px;
    }
    
    /* Improved instructions box */
    #instructions {
      margin: 20px 0;
      padding: 16px 20px;
      background: #fff3cd;
      border-left: 4px solid #ffc107;
      border-radius: 8px;
      font-size: 15px;
      color: #856404;
      line-height: 1.7;
    }
    
    #instructions:empty {
      display: none;
    }
    
    /* Link styling */
    a {
      color: #004488;
      text-decoration: none;
      transition: all 0.2s;
    }
    
    a:hover {
      color: #0066cc;
    }

    @media (max-width: 768px) {
      h1 {
        font-size: 1.8rem;
      }
      
      .problem-grid {
        grid-template-columns: repeat(5, 1fr);
      }
      
      nav a {
        padding: 16px 12px;
        font-size: 14px;
      }
      
      .problem {
        padding: 16px;
        padding-top: 48px;
      }
    }
  </style>

  <script>
    window.MathJax = {
      tex: {
        inlineMath: [['$', '$'], ['\\(', '\\)']],
        displayMath: [['$$', '$$'], ['\\[', '\\]']]
      },
      options: {
        ignoreHtmlClass: 'no-mathjax',
        processHtmlClass: 'mathjax-process'
      }
    };
  </script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/core-js/3.32.1/minified.js"></script>
  <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
</head>
<body>
  <nav>
    <div style="max-width: 1200px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; padding: 0 20px;">
      <a href="index.html" style="font-size: 20px; font-weight: 600; padding: 16px 0;">Mock AIME</a>
      <div style="display: flex; gap: 0;">
        <a href="search.html">Search</a>
        <a href="admin.html">Admin</a>
        <a href="login.html">Login</a>
      </div>
    </div>
  </nav>

  <div style="max-width: 900px; margin: 0 auto; padding: 0 20px;">
    <h1>Mock AIME Generator</h1>
    <div style="background: white; padding: 32px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); margin-bottom: 32px; border: 1px solid #e9ecef;">
      <div class="mode-toggle">
        <label>
          <input type="checkbox" id="expandedDbCheckbox" />
          Use Expanded Problem Database
        </label>
        &nbsp;&nbsp;&nbsp;
        <label>
          <input type="checkbox" id="fullDbCheckbox" />
          Use Full Database (No Automatic Answer Check)
        </label>
        <br><br>
        <label>
          <input type="checkbox" id="onlyReviewedCheckbox" />
          Only Use Manually Reviewed Problems
        </label>
        &nbsp;&nbsp;&nbsp;
        <label>
          <input type="checkbox" id="excludeBadCheckbox" />
          Exclude Bad Problems
        </label>
      </div>
      <label for="difficulty" style="font-weight: 600; color: #004488; font-size: 15px;">Select Difficulty Level:</label>
      <select id="difficulty">
        <option value="1">1 - Easiest</option>
        <option value="2">2</option>
        <option value="3">3</option>
        <option value="4">4</option>
        <option value="5" selected>5</option>
        <option value="6">6</option>
        <option value="7">7</option>
        <option value="8">8</option>
        <option value="9">9</option>
        <option value="10">10 - Hardest</option>
      </select>

      <div style="margin-top: 24px;">
        <button id="generateBtn" onclick="generateMock()">Generate Mock</button>
        <button id="checkBtn" onclick="checkAnswers()">Check Answers</button>
      </div>
    </div>

    <div id="instructions"></div>
    <div class="stats" id="stats"></div>
    <div id="summary"></div>
    <div id="problems"></div>

    <div id="reportModal" class="modal">
      <div class="modal-content">
        <span class="modal-close" onclick="closeReportModal()">&times;</span>
        <div class="modal-header">Report Problem Issue</div>
        
        <label class="modal-label">Issue Type:</label>
        <select id="reportType" class="modal-select">
          <option value="wrong_answer">Wrong Answer</option>
          <option value="wrong_latex">Wrong LaTeX / Formatting</option>
          <option value="unclear_problem">Unclear Problem Statement</option>
          <option value="other">Other</option>
        </select>
        
        <label class="modal-label">Additional Details (Optional):</label>
        <textarea id="reportDetails" class="modal-textarea" placeholder="Please provide any additional information about the issue..."></textarea>
        
        <button class="modal-submit" id="submitReport">Submit Report</button>
      </div>
    </div>

    <script>
      const expandedCheckbox = document.getElementById('expandedDbCheckbox');
      const fullCheckbox = document.getElementById('fullDbCheckbox');
      expandedCheckbox.addEventListener('change', () => {
        if (expandedCheckbox.checked) fullCheckbox.checked = false;
      });
      fullCheckbox.addEventListener('change', () => {
        if (fullCheckbox.checked) expandedCheckbox.checked = false;
      });

      const difficultyTemplate = {
        "1": { "2.5": 1, "3.0": 3, "3.5": 3, "4.0": 3, "4.5": 2, "5.0": 2, "5.5": 1, "6.0": 0, "6.5": 0, "7.0": 0, "7.5": 0, "8.0": 0 },
        "2": { "2.5": 1, "3.0": 3, "3.5": 3, "4.0": 2, "4.5": 2, "5.0": 1, "5.5": 1, "6.0": 1, "6.5": 1, "7.0": 0, "7.5": 0, "8.0": 0 },
        "3": { "2.5": 0, "3.0": 3, "3.5": 2, "4.0": 3, "4.5": 2, "5.0": 1, "5.5": 1, "6.0": 1, "6.5": 2, "7.0": 0, "7.5": 0, "8.0": 0 },
        "4": { "2.5": 0, "3.0": 3, "3.5": 2, "4.0": 2, "4.5": 2, "5.0": 2, "5.5": 1, "6.0": 1, "6.5": 1, "7.0": 1, "7.5": 0, "8.0": 0 },
        "5": { "2.5": 0, "3.0": 2, "3.5": 3, "4.0": 2, "4.5": 1, "5.0": 2, "5.5": 2, "6.0": 1, "6.5": 1, "7.0": 1, "7.5": 0, "8.0": 0 },
        "6": { "2.5": 0, "3.0": 2, "3.5": 2, "4.0": 2, "4.5": 2, "5.0": 1, "5.5": 2, "6.0": 2, "6.5": 1, "7.0": 1, "7.5": 0, "8.0": 0 },
        "7": { "2.5": 0, "3.0": 2, "3.5": 2, "4.0": 1, "4.5": 1, "5.0": 2, "5.5": 2, "6.0": 1, "6.5": 1, "7.0": 2, "7.5": 1, "8.0": 0 },
        "8": { "2.5": 0, "3.0": 1, "3.5": 2, "4.0": 2, "4.5": 1, "5.0": 2, "5.5": 2, "6.0": 2, "6.5": 1, "7.0": 1, "7.5": 1, "8.0": 0 },
        "9": { "2.5": 0, "3.0": 1, "3.5": 1, "4.0": 2, "4.5": 1, "5.0": 2, "5.5": 2, "6.0": 1, "6.5": 2, "7.0": 1, "7.5": 2, "8.0": 0 },
        "10": { "2.5": 0, "3.0": 0, "3.5": 1, "4.0": 2, "4.5": 2, "5.0": 1, "5.5": 2, "6.0": 2, "6.5": 1, "7.0": 1, "7.5": 2, "8.0": 1 }
      };

      function bucketizeFine() {
        const buckets = {};
        for (let d = 2.5; d <= 8; d += 0.5) {
          buckets[d.toFixed(1)] = [];
        }

        const useExpanded = expandedCheckbox.checked;
        const useFull = fullCheckbox.checked;
        const onlyReviewed = document.getElementById('onlyReviewedCheckbox').checked;
        const excludeBad = document.getElementById('excludeBadCheckbox').checked;

        for (const p of allProblems) {
          let d = parseFloat(p.difficulty);
          if (isNaN(d)) continue;
          if (onlyReviewed && !p.manually_reviewed) continue;
          if (excludeBad && p.bad_problem) continue;

          if (useFull) {
            const key = (Math.round(d * 2) / 2).toFixed(1);
            if (buckets[key]) {
              buckets[key].push(p);
            }
            continue;
          }

          if (useExpanded) {
            if (p.aime_answer === null || p.aime_answer === undefined) continue;
          } else {
            const answerNum = parseInt(p.answer);
            if (isNaN(answerNum) || answerNum < 0 || answerNum > 999) continue;
          }

          const key = (Math.round(d * 2) / 2).toFixed(1);
          if (buckets[key]) {
            buckets[key].push(p);
          }
        }

        return buckets;
      }

      function sample(arr, n) {
        const copy = [...arr];
        const result = [];
        while (result.length < n && copy.length > 0) {
          const idx = Math.floor(Math.random() * copy.length);
          result.push(copy.splice(idx, 1)[0]);
        }
        return result;
      }

      let currentReportProblemId = null;

      function openReportModal(problemId) {
        currentReportProblemId = problemId;
        document.getElementById('reportModal').style.display = 'block';
        document.getElementById('reportDetails').value = '';
        document.getElementById('reportType').value = 'wrong_answer';
      }

      function closeReportModal() {
        document.getElementById('reportModal').style.display = 'none';
        currentReportProblemId = null;
      }

      window.onclick = function(event) {
        const modal = document.getElementById('reportModal');
        if (event.target === modal) {
          closeReportModal();
        }
      }

      document.getElementById('submitReport').addEventListener('click', async () => {
        if (!currentReportProblemId) return;

        const submitButton = document.getElementById('submitReport');
        submitButton.disabled = true;
        submitButton.textContent = 'Submitting...';

        const reportType = document.getElementById('reportType').value;
        const details = document.getElementById('reportDetails').value.trim();

        try {
          const { error } = await supabaseClient
            .from('problem_reports')
            .insert([
              {
                problem_id: currentReportProblemId,
                report_type: reportType,
                details: details || null,
                created_at: new Date().toISOString()
              }
            ]);

          if (error) {
            console.error('Error submitting report:', error);
            alert('Failed to submit report. Please try again.');
          } else {
            alert('Thank you! Your report has been submitted.');
            closeReportModal();
          }
        } catch (err) {
          console.error('Error:', err);
          alert('Failed to submit report. Please try again.');
        } finally {
          submitButton.disabled = false;
          submitButton.textContent = 'Submit Report';
        }
      });

      async function replaceProblem(index) {
        const currentProblem = chosenProblems[index];
        const currentDifficulty = (Math.round(parseFloat(currentProblem.difficulty) * 2) / 2).toFixed(1);
        
        const useExpanded = expandedCheckbox.checked;
        const useFull = fullCheckbox.checked;
        const onlyReviewed = document.getElementById('onlyReviewedCheckbox').checked;
        const excludeBad = document.getElementById('excludeBadCheckbox').checked;
        
        let availableProblems = [];
        
        for (const p of allProblems) {
          const d = parseFloat(p.difficulty);
          if (isNaN(d)) continue;
          
          const bucketDiff = (Math.round(d * 2) / 2).toFixed(1);
          if (bucketDiff !== currentDifficulty) continue;
          if (onlyReviewed && !p.manually_reviewed) continue;
          if (excludeBad && p.bad_problem) continue;
          if (useFull) {
            availableProblems.push(p);
          } else if (useExpanded) {
            if (p.aime_answer !== null && p.aime_answer !== undefined) {
              availableProblems.push(p);
            }
          } else {
            const answerNum = parseInt(p.answer);
            if (!isNaN(answerNum) && answerNum >= 0 && answerNum <= 999) {
              availableProblems.push(p);
            }
          }
        }
        
        const usedIds = new Set(chosenProblems.map(p => p.id));
        availableProblems = availableProblems.filter(p => !usedIds.has(p.id));
        
        if (availableProblems.length === 0) {
          alert(`No more problems available at difficulty ${currentDifficulty}`);
          return;
        }
        
        const newProblem = availableProblems[Math.floor(Math.random() * availableProblems.length)];
        chosenProblems[index] = newProblem;
        
        const problemDiv = document.querySelector(`.problem[data-problem-index="${index}"]`);
        if (!problemDiv) return;
        
        problemDiv.className = "problem mathjax-process";
        problemDiv.setAttribute("data-problem-index", index);
        
        if (useFull) {
          problemDiv.innerHTML = `
            <a href="${newProblem.link}" target="_blank" class="aops-link-top">View Discussion</a>
            <strong>Problem ${index + 1}:</strong>
            <span class="difficulty-indicator">Difficulty: ${parseFloat(newProblem.difficulty).toFixed(1)}</span>
            <p>${newProblem.text}</p>
            <div>
              <label><input type="checkbox" class="override" data-index="${index}" /> I was correct</label>
            </div>
            <div><strong>Source:</strong> ${newProblem.source || "Unknown"}</div>
            <div style="margin-top: 12px;">
              <button class="replace-button" onclick="replaceProblem(${index})">Replace Problem</button>
              <button class="report-button" onclick="openReportModal(${newProblem.id})">Report Issue</button>
            </div>
          `;
        } else {
          problemDiv.innerHTML = `
            <a href="${newProblem.link}" target="_blank" class="aops-link-top">View Discussion</a>
            <strong>Problem ${index + 1}:</strong>
            <span class="difficulty-indicator">Difficulty: ${parseFloat(newProblem.difficulty).toFixed(1)}</span>
            <p>${newProblem.text}</p>
            <div class="answer">Answer: <input type="text" maxlength="3" data-index="${index}" placeholder="000" /></div>
            <div style="margin-top: 12px;">
              <button class="replace-button" onclick="replaceProblem(${index})">Replace Problem</button>
              <button class="report-button" onclick="openReportModal(${newProblem.id})">Report Issue</button>
            </div>
          `;
        }
        
        if (window.MathJax) {
          try {
            await MathJax.typesetPromise([problemDiv]);
          } catch (err) {
            console.error('MathJax typeset failed: ', err);
          }
        }
      }

      async function generateMock() {
        if (allProblems.length === 0) {
          alert("Problems are still loading, please wait a moment.");
          return;
        }

        const useExpanded = expandedCheckbox.checked;
        const useFull = fullCheckbox.checked;
        const level = document.getElementById("difficulty").value;

        document.getElementById("instructions").textContent = "";
        document.getElementById("summary").textContent = "";

        if (useExpanded) {
          document.getElementById("instructions").textContent =
    `Note: Problems in the expanded database may include answers not limited to positive integers from 0 to 999.
    Examples include fractions (e.g., \\( \\frac{3}{5} \\)), powers (e.g., \\( 2^{10} \\)), or sums.
    Enter your answer as the sum of components mod 1000.
    Examples:
    - \\( \\frac{3}{5} \\) → 8
    - \\( 2^{10} / 3 \\) → 15
    - \\( 7 \\) → 7
    `;
        }

        if (useFull) {
          document.getElementById("instructions").textContent =
    `Note: Problems in the full database may not have answers available for automatic checking.
    You will need to manually check the answers for these problems.`;
        }

        const buckets = bucketizeFine();
        const plan = difficultyTemplate[level];

        let statText = "Available / Needed problems:\n";
        for (const [diff, countNeeded] of Object.entries(plan)) {
          const available = buckets[diff]?.length || 0;
          statText += `  (${diff}): ${available} / ${countNeeded}\n`;
        }
        document.getElementById("stats").innerHTML = `
          <div style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); margin-bottom: 32px; border: 1px solid #e9ecef;">
            <details>
              <summary style="cursor: pointer; font-weight: 600; color: #004488; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;">Available problems by difficulty (click to expand)</summary>
              <pre style="margin-top: 15px; font-size: 14px; line-height: 1.8; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;">${statText}</pre>
            </details>
          </div>
        `;

        for (const [diff, countNeeded] of Object.entries(plan)) {
          if ((buckets[diff]?.length || 0) < countNeeded) {
            document.getElementById("problems").innerHTML =
              `<p style="color:red;"><strong>Not enough problems in bucket ${diff} to generate mock.</strong></p>`;
            return;
          }
        }

        chosenProblems = [];
        for (const [diff, count] of Object.entries(plan)) {
          chosenProblems.push(...sample(buckets[diff], count));
        }

        const container = document.getElementById("problems");
        container.innerHTML = "";

        chosenProblems.forEach((p, i) => {
          const div = document.createElement("div");
          div.className = "problem mathjax-process";
          div.setAttribute("data-problem-index", i);

          if (useFull) {
            div.innerHTML = `
              <a href="${p.link}" target="_blank" class="aops-link-top">View Discussion</a>
              <strong>Problem ${i + 1}:</strong>
              <span class="difficulty-indicator">Difficulty: ${parseFloat(p.difficulty).toFixed(1)}</span>
              <p>${p.text}</p>
              <div>
                <label><input type="checkbox" class="override" data-index="${i}" /> I was correct</label>
              </div>
              <div><strong>Source:</strong> ${p.source || "Unknown"}</div>
              <div style="margin-top: 12px;">
                <button class="replace-button" onclick="replaceProblem(${i})">Replace Problem</button>
                <button class="report-button" onclick="openReportModal(${p.id})">Report Issue</button>
              </div>
            `;
          } else {
            div.innerHTML = `
              <a href="${p.link}" target="_blank" class="aops-link-top">View Discussion</a>
              <strong>Problem ${i + 1}:</strong>
              <span class="difficulty-indicator">Difficulty: ${parseFloat(p.difficulty).toFixed(1)}</span>
              <p>${p.text}</p>
              <div class="answer">Answer: <input type="text" maxlength="3" data-index="${i}" placeholder="000" /></div>
              <div style="margin-top: 12px;">
                <button class="replace-button" onclick="replaceProblem(${i})">Replace Problem</button>
                <button class="report-button" onclick="openReportModal(${p.id})">Report Issue</button>
              </div>
            `;
          }

          container.appendChild(div);
        });

        if (window.MathJax) {
          try {
            await MathJax.typesetPromise();
          } catch (err) {
            console.error('MathJax typeset failed: ', err);
          }
        }
      }

      function checkAnswers() {
        let correctCount = 0;
        let results = [];

        chosenProblems.forEach((p, i) => {
          const overrideCheckbox = document.querySelector(`input.override[data-index="${i}"]`);
          const userOverride = overrideCheckbox?.checked || false;
          const problemDiv = document.querySelector(`.problem[data-problem-index="${i}"]`);
          
          const existingIcon = problemDiv?.querySelector('.status-icon');
          if (existingIcon) existingIcon.remove();

          if (userOverride) {
            correctCount++;
            results.push({ index: i, status: 'override' });
            if (problemDiv) {
              const icon = document.createElement('div');
              icon.className = 'status-icon override';
              icon.textContent = '✓';
              problemDiv.appendChild(icon);
            }
            return;
          }

          const answerInput = document.querySelector(`input[data-index="${i}"]:not(.override)`);

          if (answerInput) {
            const userAnswer = answerInput.value.trim();
            
            if (userAnswer === '') {
              results.push({ index: i, status: 'unanswered' });
              if (problemDiv) {
                const icon = document.createElement('div');
                icon.className = 'status-icon unanswered';
                icon.textContent = '–';
                problemDiv.appendChild(icon);
              }
              return;
            }
            
            let correct = false;

            if ("aime_answer" in p) {
              const expected = String(p.aime_answer % 1000);
              correct = userAnswer === expected;
            } else if ("answer" in p) {
              correct = userAnswer === String(p.answer);
            }

            if (correct) correctCount++;
            results.push({ index: i, status: correct ? 'correct' : 'incorrect' });
            
            if (problemDiv) {
              const icon = document.createElement('div');
              icon.className = `status-icon ${correct ? 'correct' : 'incorrect'}`;
              icon.textContent = correct ? '✓' : '✗';
              problemDiv.appendChild(icon);
            }
          } else {
            results.push({ index: i, status: 'unanswered' });
          }
        });

        const summaryDiv = document.getElementById("summary");
        summaryDiv.innerHTML = `
          <div class="summary-header">Score: ${correctCount} / ${chosenProblems.length}</div>
          <div class="problem-grid">
            ${results.map(r => `
              <div class="problem-indicator ${r.status}" title="Problem ${r.index + 1}: ${r.status}">
                ${r.index + 1}
              </div>
            `).join('')}
          </div>
        `;
      }
    </script>
  </div>
</body>
</html>