<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <meta name="description" content="Generate realistic AIME mock tests with customizable difficulty levels. Practice for the American Invitational Mathematics Examination with 3000+ non-AIME problems.">
  <meta name="keywords" content="AIME, AIME practice, mock AIME, AIME problems, math competition, AMC preparation">
  <meta name="author" content="Mock AIME Generator">
  <title>Mock AIME Generator - Practice Tests for AIME</title>
  <meta property="og:title" content="Mock AIME Generator">
  <meta property="og:description" content="Generate realistic AIME mock tests with customizable difficulty levels">
  <meta property="og:url" content="https://mockaime.com">
  <meta property="og:type" content="website">

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.50.4/dist/umd/supabase.min.js"></script>

  <script>
    const SUPABASE_URL = 'https://ftdbplxkyaocyrjpmjyb.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZ0ZGJwbHhreWFvY3lyanBtanliIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTIxMDgxMDUsImV4cCI6MjA2NzY4NDEwNX0.hE0V09JxdLYNbZqPVH3HZxNpLPP2rXIaBsNGUHO3upc';

    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // SECURITY FIX: HTML escaping function
    function escapeHtml(text) {
      if (!text) return text;
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // SECURITY FIX: Safe content insertion function
    function setMathContent(element, content) {
      if (!content) {
        element.innerHTML = '<em>No content</em>';
        return;
      }
      // Use textContent to safely insert the content, then let MathJax process it
      element.textContent = content;
      // Re-render MathJax for this element
      if (window.MathJax) {
        MathJax.typesetPromise([element]).catch(err => console.error('MathJax error:', err));
      }
    }

    async function loadProblemsFromSupabase() {
      let allProblems = [];
      let from = 0;
      const chunkSize = 1000;
      let done = false;

      while (!done) {
        const { data, error } = await supabaseClient
          .from('problems')
          .select('*')
          .range(from, from + chunkSize - 1);

        if (error) {
          console.error('Error fetching problems:', error);
          alert('Failed to load problems from database.');
          return [];
        }

        if (data.length === 0) {
          done = true;
        } else {
          allProblems.push(...data);
          from += chunkSize;
          
          // Update loading progress
          const loadingEl = document.getElementById('loadingProgress');
          if (loadingEl) {
            loadingEl.textContent = `Loading problems... ${allProblems.length}`;
          }
        }
      }

      console.log('Loaded', allProblems.length, 'problems from Supabase');
      return allProblems;
    }

    let allProblems = [];
    let chosenProblems = [];
    let problemsLoaded = false;
    let currentUser = null;

    // Authentication functions
    async function updateAuthUI() {
      const { data: { session } } = await supabaseClient.auth.getSession();
      currentUser = session?.user || null;
      
      const authButton = document.querySelector('.auth-button');
      const userInfo = document.querySelector('.user-info');
      
      if (currentUser) {
        // User is logged in
        if (authButton) {
          authButton.textContent = 'Profile';
          authButton.href = 'profile.html';
        }
        
        // Add user info and sign out button
        if (userInfo) {
          const displayName = currentUser.user_metadata?.display_name || currentUser.email;
          userInfo.innerHTML = `
            <span style="color: white; margin-right: 15px;">Welcome, ${escapeHtml(displayName)}!</span>
            <button onclick="signOut()" style="background: transparent; border: 1px solid rgba(255,255,255,0.3); color: white; padding: 8px 16px; border-radius: 6px; cursor: pointer;">Sign Out</button>
          `;
        }
      } else {
        // User is not logged in
        if (authButton) {
          authButton.textContent = 'Login';
          authButton.href = 'login.html';
        }
        if (userInfo) {
          userInfo.innerHTML = '';
        }
      }
    }

    async function signOut() {
      await supabaseClient.auth.signOut();
      await updateAuthUI();
    }

    async function saveMockAttempt(score, totalProblems, difficulty, problemsData) {
      if (!currentUser) return; // User not logged in
      
      try {
        const { error } = await supabaseClient
          .from('mock_attempts')
          .insert([
            {
              user_id: currentUser.id,
              difficulty_level: parseInt(difficulty),
              score: score,
              total_problems: totalProblems,
              problems_data: problemsData,
              completed_at: new Date().toISOString()
            }
          ]);
        
        if (error) {
          console.error('Error saving attempt:', error);
        } else {
          console.log('Mock attempt saved successfully');
        }
      } catch (err) {
        console.error('Error saving mock attempt:', err);
      }
    }

    window.onload = async () => {
      await updateAuthUI();
      updateButtonStates();
      allProblems = await loadProblemsFromSupabase();
      problemsLoaded = true;
      updateButtonStates();
      
      const loadingEl = document.getElementById('loadingProgress');
      if (loadingEl) {
        loadingEl.style.display = 'none';
      }
    };

    function updateButtonStates() {
      const generateBtn = document.getElementById('generateBtn');
      const checkBtn = document.getElementById('checkBtn');
      
      if (problemsLoaded) {
        generateBtn.disabled = false;
        checkBtn.disabled = false;
        generateBtn.style.opacity = '1';
        checkBtn.style.opacity = '1';
        generateBtn.style.cursor = 'pointer';
        checkBtn.style.cursor = 'pointer';
      } else {
        generateBtn.disabled = true;
        checkBtn.disabled = true;
        generateBtn.style.opacity = '0.5';
        checkBtn.style.opacity = '0.5';
        generateBtn.style.cursor = 'not-allowed';
        checkBtn.style.cursor = 'not-allowed';
      }
    }
  </script>

  <style>
    :root {
      --bg-primary: #f8f9fa;
      --bg-secondary: #e9ecef;
      --bg-card: white;
      --text-primary: #212529;
      --text-secondary: #495057;
      --text-tertiary: #6c757d;
      --border-color: #e9ecef;
      --border-strong: #dee2e6;
      --primary-blue: #004488;
      --primary-blue-light: #0066cc;
      --shadow-sm: 0 2px 8px rgba(0,0,0,0.08);
      --shadow-md: 0 4px 16px rgba(0,0,0,0.12);
      --instruction-bg: #fff3cd;
      --instruction-border: #ffc107;
      --instruction-text: #856404;
    }

    [data-theme="dark"] {
      --bg-primary: #1a1a1a;
      --bg-secondary: #2d2d2d;
      --bg-card: #2d2d2d;
      --text-primary: #e0e0e0;
      --text-secondary: #b0b0b0;
      --text-tertiary: #888888;
      --border-color: #404040;
      --border-strong: #555555;
      --primary-blue: #4a9eff;
      --primary-blue-light: #6bb3ff;
      --shadow-sm: 0 2px 8px rgba(0,0,0,0.3);
      --shadow-md: 0 4px 16px rgba(0,0,0,0.4);
      --instruction-bg: #3d3520;
      --instruction-border: #d4a50a;
      --instruction-text: #f0d98d;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
      margin: 0;
      padding: 0;
      background: linear-gradient(to bottom, var(--bg-primary) 0%, var(--bg-secondary) 100%);
      font-size: 16px;
      line-height: 1.6;
      color: var(--text-primary);
      transition: background 0.3s, color 0.3s;
    }
    
    h1 {
      text-align: center;
      color: var(--primary-blue);
      font-weight: 700;
      font-size: 2.5rem;
      margin-bottom: 0.5rem;
    }
    
    nav {
      background: linear-gradient(135deg, var(--primary-blue) 0%, var(--primary-blue-light) 100%);
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      margin-bottom: 48px;
    }
    
    nav a {
      color: white;
      text-decoration: none;
      padding: 20px 24px;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      display: inline-block;
      font-weight: 500;
    }
    
    nav a:hover {
      background: rgba(255,255,255,0.15);
      border-radius: 4px;
    }

    .dark-mode-toggle {
      background: transparent;
      border: 2px solid rgba(255,255,255,0.3);
      color: white;
      padding: 8px 16px;
      font-size: 14px;
      cursor: pointer;
      border-radius: 20px;
      transition: all 0.2s;
    }

    .dark-mode-toggle:hover {
      background: rgba(255,255,255,0.1);
      border-color: rgba(255,255,255,0.5);
      transform: none;
    }
    
    select, button {
      font-size: 16px;
      padding: 12px 20px;
      margin: 8px 5px;
      border-radius: 8px;
      border: 1px solid var(--border-strong);
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      font-weight: 500;
    }
    
    button {
      background: linear-gradient(135deg, var(--primary-blue) 0%, var(--primary-blue-light) 100%);
      color: white;
      border: none;
      cursor: pointer;
      box-shadow: 0 2px 4px rgba(0,68,136,0.2);
    }
    
    button:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,68,136,0.3);
    }
    
    button:active:not(:disabled) {
      transform: translateY(0);
    }
    
    button:disabled {
      cursor: not-allowed;
      opacity: 0.5;
    }
    
    select {
      background: var(--bg-card);
      color: var(--text-primary);
      cursor: pointer;
    }
    
    select:focus {
      outline: none;
      border-color: var(--primary-blue-light);
      box-shadow: 0 0 0 3px rgba(0,102,204,0.1);
    }

    .loading-indicator {
      text-align: center;
      padding: 20px;
      background: var(--bg-card);
      border-radius: 12px;
      margin: 20px 0;
      box-shadow: var(--shadow-sm);
    }

    .loading-spinner {
      display: inline-block;
      width: 40px;
      height: 40px;
      border: 4px solid var(--border-color);
      border-top: 4px solid var(--primary-blue);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .problem-nav {
      position: sticky;
      top: 20px;
      z-index: 100;
      background: var(--bg-card);
      padding: 20px;
      border-radius: 12px;
      box-shadow: var(--shadow-sm);
      margin: 20px 0;
      border: 1px solid var(--border-color);
    }

    .problem-nav-title {
      font-weight: 600;
      margin-bottom: 12px;
      color: var(--text-primary);
    }

    .problem-nav-grid {
      display: grid;
      grid-template-columns: repeat(15, 1fr);
      gap: 8px;
    }

    .problem-nav-item {
      aspect-ratio: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--bg-secondary);
      border: 2px solid var(--border-color);
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      font-size: 14px;
      transition: all 0.2s;
      color: var(--text-primary);
    }

    .problem-nav-item:hover {
      transform: scale(1.1);
      border-color: var(--primary-blue);
    }

    .problem-nav-item.answered {
      background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
      border-color: #4caf50;
    }

    [data-theme="dark"] .problem-nav-item.answered {
      background: linear-gradient(135deg, #1b5e20 0%, #2e7d32 100%);
      border-color: #66bb6a;
      color: #e0e0e0;
    }
    
    .problem {
      background: var(--bg-card);
      padding: 24px;
      padding-top: 48px;
      margin: 20px 0;
      border-radius: 12px;
      box-shadow: var(--shadow-sm);
      border: 1px solid var(--border-color);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      scroll-margin-top: 120px;
    }
    
    .problem:hover {
      transform: translateY(-4px);
      box-shadow: var(--shadow-md);
      border-color: var(--primary-blue);
    }

    @keyframes problemPulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.02); }
    }

    .problem.pulse {
      animation: problemPulse 0.3s ease-in-out;
    }

    .quality-badge {
      position: absolute;
      bottom: 12px;
      right: 12px;
      background: linear-gradient(135deg, #ffc107 0%, #ffb300 100%);
      color: #000;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: 600;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      display: flex;
      align-items: center;
      gap: 2px;
    }

    .quality-badge.quality-0,
    .quality-badge.no-quality {
      background: linear-gradient(135deg, #6c757d 0%, #5a6268 100%);
      color: white;
    }

    .quality-badge.quality-1 {
      background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
      color: white;
    }

    .quality-badge.quality-2 {
      background: linear-gradient(135deg, #fd7e14 0%, #e55a00 100%);
      color: white;
    }

    .quality-badge.quality-3 {
      background: linear-gradient(135deg, #ffc107 0%, #e0a800 100%);
      color: #000;
    }

    .quality-badge.quality-4 {
      background: linear-gradient(135deg, #28a745 0%, #1e7e34 100%);
      color: white;
    }

    .quality-badge.quality-5 {
      background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
      color: white;
    }
    
    .answer {
      margin-top: 16px;
      margin-bottom: 12px;
    }

    .answer-label {
      color: var(--text-secondary);
      font-weight: 500;
    }
    
    input[type="text"] {
      padding: 8px 12px;
      font-size: 16px;
      width: 80px;
      border: 2px solid var(--border-strong);
      border-radius: 8px;
      transition: all 0.2s;
      font-weight: 500;
      text-align: center;
      background: var(--bg-card);
      color: var(--text-primary);
    }
    
    input[type="text"]:focus {
      outline: none;
      border-color: var(--primary-blue-light);
      box-shadow: 0 0 0 4px rgba(74, 158, 255, 0.1);
    }

    input[type="text"]::placeholder {
      color: var(--text-tertiary);
      opacity: 0.5;
    }
    
    .stats {
      margin: 0 0 16px 0;
      font-size: 15px;
      color: var(--text-secondary);
    }
    
    .stats:empty {
      display: none;
    }
    
    .result {
      display: inline-block;
      margin-left: 12px;
      font-size: 20px;
      font-weight: 700;
    }
    
    .correct {
      color: #28a745;
    }
    
    .incorrect {
      color: #dc3545;
    }
    
    .difficulty-indicator {
      display: inline-block;
      background: linear-gradient(135deg, var(--bg-secondary) 0%, var(--border-color) 100%);
      padding: 4px 12px;
      border-radius: 6px;
      font-size: 13px;
      margin-left: 12px;
      color: var(--text-secondary);
      font-weight: 600;
    }
    
    #summary {
      margin: 24px 0;
      padding: 24px;
      background: var(--bg-card);
      border-radius: 12px;
      box-shadow: var(--shadow-sm);
      border: 1px solid var(--border-color);
    }

    @keyframes summarySlideIn {
      from {
        opacity: 0;
        transform: translateY(-20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    #summary.show {
      animation: summarySlideIn 0.5s ease-out;
    }
    
    .summary-header {
      font-size: 24px;
      font-weight: 700;
      color: var(--primary-blue);
      margin-bottom: 20px;
    }

    .show-answers-btn {
      margin-top: 16px;
      background: #6c757d;
    }

    .show-answers-btn:hover:not(:disabled) {
      background: #5a6268;
    }

    .answer-reveal {
      margin-top: 12px;
      padding: 12px;
      background: var(--bg-secondary);
      border-radius: 6px;
      border-left: 4px solid var(--primary-blue);
      display: none;
    }

    .answer-reveal.show {
      display: block;
      animation: summarySlideIn 0.3s ease-out;
    }

    .answer-reveal strong {
      color: var(--primary-blue);
    }
    
    .problem-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(50px, 1fr));
      gap: 12px;
      max-width: 650px;
    }
    
    .problem-indicator {
      width: 50px;
      height: 50px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 18px;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      border: 2px solid transparent;
      cursor: default;
    }
    
    .problem-indicator:hover {
      transform: scale(1.1);
    }
    
    .problem-indicator.unanswered {
      background: var(--bg-secondary);
      color: var(--text-tertiary);
      border-color: var(--border-strong);
    }
    
    .problem-indicator.correct {
      background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
      color: #155724;
      border-color: #28a745;
      box-shadow: 0 2px 4px rgba(40,167,69,0.2);
    }

    [data-theme="dark"] .problem-indicator.correct {
      background: linear-gradient(135deg, #1b5e20 0%, #2e7d32 100%);
      color: #a5d6a7;
    }
    
    .problem-indicator.incorrect {
      background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%);
      color: #721c24;
      border-color: #dc3545;
      box-shadow: 0 2px 4px rgba(220,53,69,0.2);
    }

    [data-theme="dark"] .problem-indicator.incorrect {
      background: linear-gradient(135deg, #b71c1c 0%, #c62828 100%);
      color: #ef9a9a;
    }
    
    .problem-indicator.override {
      background: linear-gradient(135deg, #d1ecf1 0%, #bee5eb 100%);
      color: #0c5460;
      border-color: #17a2b8;
      box-shadow: 0 2px 4px rgba(23,162,184,0.2);
    }

    [data-theme="dark"] .problem-indicator.override {
      background: linear-gradient(135deg, #006064 0%, #00838f 100%);
      color: #80deea;
    }
    
    .status-icon {
      position: absolute;
      top: 16px;
      right: 16px;
      font-size: 32px;
      font-weight: 700;
      opacity: 0;
      transition: opacity 0.3s;
    }

    .status-icon.show {
      opacity: 0.9;
    }
    
    .status-icon.correct {
      color: #28a745;
    }
    
    .status-icon.incorrect {
      color: #dc3545;
    }
    
    .status-icon.override {
      color: #17a2b8;
    }
    
    .status-icon.unanswered {
      color: var(--text-tertiary);
    }
    
    .replace-button, .report-button {
      display: inline-block;
      margin-top: 12px;
      padding: 8px 16px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    .replace-button {
      background: #6c757d;
      color: white;
      margin-right: 8px;
    }
    
    .replace-button:hover {
      background: #5a6268;
      transform: translateY(-1px);
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    
    .report-button {
      background: #ffe69c;
      color: #000;
    }
    
    .report-button:hover {
      background: #ffd43b;
      transform: translateY(-1px);
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }

    .aops-link-top {
      position: absolute;
      top: 16px;
      right: 16px;
      color: var(--primary-blue);
      text-decoration: none;
      font-size: 14px;
      font-weight: 500;
      padding: 6px 12px;
      border-radius: 6px;
      transition: all 0.2s;
      background: transparent;
    }
    
    .aops-link-top:hover {
      background: var(--bg-secondary);
      color: var(--primary-blue-light);
    }
    
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
      backdrop-filter: blur(4px);
    }
    
    .modal-content {
      background-color: var(--bg-card);
      margin: 10% auto;
      padding: 32px;
      border-radius: 12px;
      width: 90%;
      max-width: 500px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.3);
      animation: modalSlideIn 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    @keyframes modalSlideIn {
      from {
        transform: translateY(-20px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }
    
    .modal-header {
      font-size: 22px;
      font-weight: 700;
      margin-bottom: 24px;
      color: var(--primary-blue);
    }
    
    .modal-close {
      float: right;
      font-size: 28px;
      font-weight: 700;
      cursor: pointer;
      color: var(--text-tertiary);
      transition: color 0.2s;
    }
    
    .modal-close:hover {
      color: var(--text-secondary);
    }
    
    .modal-label {
      display: block;
      margin: 16px 0 8px 0;
      font-weight: 600;
      color: var(--text-secondary);
    }
    
    .modal-select, .modal-textarea {
      width: 100%;
      padding: 10px 12px;
      border: 2px solid var(--border-strong);
      border-radius: 8px;
      font-family: inherit;
      font-size: 15px;
      transition: border-color 0.2s;
      background: var(--bg-card);
      color: var(--text-primary);
    }
    
    .modal-select:focus, .modal-textarea:focus {
      outline: none;
      border-color: var(--primary-blue-light);
      box-shadow: 0 0 0 3px rgba(74, 158, 255, 0.1);
    }
    
    .modal-textarea {
      min-height: 100px;
      resize: vertical;
    }
    
    .modal-submit {
      margin-top: 24px;
      padding: 12px 24px;
      background: linear-gradient(135deg, var(--primary-blue) 0%, var(--primary-blue-light) 100%);
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      font-weight: 600;
      width: 100%;
      transition: all 0.2s;
    }
    
    .modal-submit:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,68,136,0.3);
    }
    
    .modal-submit:disabled {
      background: var(--text-tertiary);
      cursor: not-allowed;
      transform: none;
    }
    
    label {
      cursor: pointer;
      user-select: none;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      font-weight: 500;
    }
    
    input[type="checkbox"] {
      cursor: pointer;
      width: 18px;
      height: 18px;
    }
    
    .mode-toggle {
      margin: 16px 0 24px 0;
      padding: 16px;
      background: var(--bg-secondary);
      border-radius: 8px;
    }
    
    #instructions {
      margin: 20px 0;
      padding: 16px 20px;
      background: var(--instruction-bg);
      border-left: 4px solid var(--instruction-border);
      border-radius: 8px;
      font-size: 15px;
      color: var(--instruction-text);
      line-height: 1.7;
    }
    
    #instructions:empty {
      display: none;
    }
    
    a {
      color: var(--primary-blue);
      text-decoration: none;
      transition: all 0.2s;
    }
    
    a:hover {
      color: var(--primary-blue-light);
    }

    /* Star rating styles */
    .quality-selector {
      display: flex;
      margin-top: 10px;
      align-items: center;
      gap: 10px;
    }

    .quality-label {
      font-weight: 600;
      color: var(--text-secondary);
      font-size: 14px;
    }

    .stars {
      display: flex;
      gap: 5px;
    }

    .star {
      font-size: 24px;
      cursor: pointer;
      color: #ddd;
      transition: color 0.2s;
      user-select: none;
    }

    .star.filled {
      color: #ffc107;
    }

    .star.hover {
      color: #ffc107;
      opacity: 0.7;
    }

    .quality-rating-text {
      color: var(--text-tertiary);
      font-size: 14px;
      margin-left: 5px;
    }

    @media (max-width: 768px) {
      h1 {
        font-size: 1.8rem;
      }
      
      .problem-grid {
        grid-template-columns: repeat(5, 1fr);
      }

      .problem-nav-grid {
        grid-template-columns: repeat(5, 1fr);
      }
      
      nav a {
        padding: 16px 12px;
        font-size: 14px;
      }
      
      .problem {
        padding: 16px;
        padding-top: 48px;
      }

      .quality-badge {
        top: 8px;
        right: 8px;
      }
    }
  </style>

  <script>
    window.MathJax = {
      tex: {
        inlineMath: [['$', '$'], ['\\(', '\\)']],
        displayMath: [['$$', '$$'], ['\\[', '\\]']]
      },
      options: {
        ignoreHtmlClass: 'no-mathjax',
        processHtmlClass: 'mathjax-process'
      }
    };
  </script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/core-js/3.32.1/minified.js"></script>
  <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
</head>
<body>
  <nav>
    <div style="max-width: 1200px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; padding: 0 20px;">
      <a href="index.html" style="font-size: 20px; font-weight: 600; padding: 16px 0;">Mock AIME</a>
      <div style="display: flex; gap: 0; align-items: center;">
        <a href="search.html">Search</a>
        <a href="admin.html">Admin</a>
        <a href="login.html" class="auth-button">Login</a>
        <div class="user-info"></div>
        <button class="dark-mode-toggle" onclick="toggleDarkMode()">ðŸŒ™ Dark</button>
      </div>
    </div>
  </nav>

  <div style="max-width: 900px; margin: 0 auto; padding: 0 20px;">
    <h1>Mock AIME Generator</h1>
    
    <div id="loadingProgress" class="loading-indicator">
      <div class="loading-spinner"></div>
      <p style="margin-top: 16px; font-weight: 500;">Loading problems...</p>
    </div>

    <div style="background: var(--bg-card); padding: 32px; border-radius: 12px; box-shadow: var(--shadow-sm); margin-bottom: 32px; border: 1px solid var(--border-color);">
      <div class="mode-toggle">
        <label>
          <input type="checkbox" id="useFinalizedOnly" />
          Use Finalized Problems Only
        </label>
        <br><br>
        <label>
          <input type="checkbox" id="useExpandedDb" />
          Use Expanded Database
        </label>
        <div class="quality-selector" id="qualitySelector">
          <span class="quality-label">Minimum Quality:</span>
          <div class="stars" id="qualityStars">
            <span class="star" data-rating="1">â˜…</span>
            <span class="star" data-rating="2">â˜…</span>
            <span class="star" data-rating="3">â˜…</span>
            <span class="star" data-rating="4">â˜…</span>
            <span class="star" data-rating="5">â˜…</span>
          </div>
          <span class="quality-rating-text" id="qualityRatingText">(3/5)</span>
        </div>
      </div>
      <label for="difficulty" style="font-weight: 600; color: var(--primary-blue); font-size: 15px;">Select Difficulty Level:</label>
      <select id="difficulty">
        <option value="1">1 - Easiest</option>
        <option value="2">2</option>
        <option value="3">3</option>
        <option value="4">4</option>
        <option value="5" selected>5</option>
        <option value="6">6</option>
        <option value="7">7</option>
        <option value="8">8</option>
        <option value="9">9</option>
        <option value="10">10 - Hardest</option>
      </select>

      <div style="margin-top: 24px;">
        <button id="generateBtn" onclick="generateMock()">Generate Mock</button>
        <button id="checkBtn" onclick="checkAnswers()">Check Answers</button>
      </div>
    </div>

    <div id="instructions"></div>
    <div class="stats" id="stats"></div>
    
    <div id="problemNav" style="display: none;" class="problem-nav">
      <div class="problem-nav-title">Jump to Problem:</div>
      <div class="problem-nav-grid" id="problemNavGrid"></div>
    </div>

    <div id="summary"></div>
    <div id="problems"></div>

    <div id="reportModal" class="modal">
      <div class="modal-content">
        <span class="modal-close" onclick="closeReportModal()">&times;</span>
        <div class="modal-header">Report Problem Issue</div>
        
        <label class="modal-label">Issue Type:</label>
        <select id="reportType" class="modal-select">
          <option value="wrong_answer">Wrong Answer</option>
          <option value="wrong_latex">Wrong LaTeX / Formatting</option>
          <option value="unclear_problem">Unclear Problem Statement</option>
          <option value="other">Other</option>
        </select>
        
        <label class="modal-label">Additional Details (Optional):</label>
        <textarea id="reportDetails" class="modal-textarea" placeholder="Please provide any additional information about the issue..."></textarea>
        
        <button class="modal-submit" id="submitReport">Submit Report</button>
      </div>
    </div>

    <script>
      // Dark mode toggle
      function toggleDarkMode() {
        const html = document.documentElement;
        const currentTheme = html.getAttribute('data-theme');
        const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
        html.setAttribute('data-theme', newTheme);
        localStorage.setItem('theme', newTheme);
        
        const btn = document.querySelector('.dark-mode-toggle');
        btn.textContent = newTheme === 'dark' ? 'â˜€ï¸ Light' : 'ðŸŒ™ Dark';
      }

      // Load saved theme
      const savedTheme = localStorage.getItem('theme') || 'light';
      document.documentElement.setAttribute('data-theme', savedTheme);
      if (savedTheme === 'dark') {
        const btn = document.querySelector('.dark-mode-toggle');
        if (btn) btn.textContent = 'â˜€ï¸ Light';
      }

      // Quality selector logic
      let selectedQuality = 3; // Default to 3 stars

      function updateQualityStars() {
        const stars = document.querySelectorAll('#qualityStars .star');
        stars.forEach((star, index) => {
          if (index < selectedQuality) {
            star.classList.add('filled');
          } else {
            star.classList.remove('filled');
          }
        });
        document.getElementById('qualityRatingText').textContent = `(${selectedQuality}/5)`;
      }

      // Star click handlers
      document.addEventListener('click', function(e) {
        if (e.target.classList.contains('star') && e.target.closest('#qualityStars')) {
          selectedQuality = parseInt(e.target.getAttribute('data-rating'));
          updateQualityStars();
        }
      });

      // Star hover handlers
      document.addEventListener('mouseenter', function(e) {
        if (e.target.classList.contains('star') && e.target.closest('#qualityStars')) {
          const rating = parseInt(e.target.getAttribute('data-rating'));
          const stars = document.querySelectorAll('#qualityStars .star');
          stars.forEach((star, index) => {
            star.classList.remove('hover');
            if (index < rating) {
              star.classList.add('hover');
            }
          });
        }
      }, true);

      document.addEventListener('mouseleave', function(e) {
        if (e.target.classList.contains('star') && e.target.closest('#qualityStars')) {
          const stars = document.querySelectorAll('#qualityStars .star');
          stars.forEach(star => star.classList.remove('hover'));
        }
      }, true);

      // Initialize quality stars
      updateQualityStars();

      const difficultyTemplate = {
        "1": { "2.5": 1, "3.0": 3, "3.5": 3, "4.0": 2, "4.5": 2, "5.0": 2, "5.5": 1, "6.0": 1, "6.5": 0, "7.0": 0, "7.5": 0, "8.0": 0 },
        "2": { "2.5": 0, "3.0": 3, "3.5": 3, "4.0": 3, "4.5": 2, "5.0": 1, "5.5": 1, "6.0": 1, "6.5": 1, "7.0": 0, "7.5": 0, "8.0": 0 },
        "3": { "2.5": 0, "3.0": 3, "3.5": 3, "4.0": 2, "4.5": 2, "5.0": 2, "5.5": 1, "6.0": 1, "6.5": 1, "7.0": 0, "7.5": 0, "8.0": 0 },
        "4": { "2.5": 0, "3.0": 3, "3.5": 2, "4.0": 2, "4.5": 3, "5.0": 2, "5.5": 1, "6.0": 1, "6.5": 1, "7.0": 0, "7.5": 0, "8.0": 0 },
        "5": { "2.5": 0, "3.0": 3, "3.5": 2, "4.0": 2, "4.5": 2, "5.0": 2, "5.5": 1, "6.0": 1, "6.5": 1, "7.0": 1, "7.5": 0, "8.0": 0 },
        "6": { "2.5": 0, "3.0": 2, "3.5": 3, "4.0": 2, "4.5": 2, "5.0": 1, "5.5": 2, "6.0": 1, "6.5": 1, "7.0": 1, "7.5": 0, "8.0": 0 },
        "7": { "2.5": 0, "3.0": 2, "3.5": 2, "4.0": 2, "4.5": 2, "5.0": 2, "5.5": 2, "6.0": 1, "6.5": 1, "7.0": 1, "7.5": 0, "8.0": 0 },
        "8": { "2.5": 0, "3.0": 2, "3.5": 2, "4.0": 2, "4.5": 2, "5.0": 2, "5.5": 1, "6.0": 1, "6.5": 1, "7.0": 1, "7.5": 1, "8.0": 0 },
        "9": { "2.5": 0, "3.0": 1, "3.5": 2, "4.0": 2, "4.5": 2, "5.0": 1, "5.5": 2, "6.0": 1, "6.5": 2, "7.0": 1, "7.5": 1, "8.0": 0 },
        "10": { "2.5": 0, "3.0": 1, "3.5": 1, "4.0": 2, "4.5": 2, "5.0": 1, "5.5": 2, "6.0": 1, "6.5": 2, "7.0": 1, "7.5": 1, "8.0": 1 }
      };
      
      function bucketizeFine() {
        const buckets = {};
        for (let d = 2.5; d <= 8; d += 0.5) {
          buckets[d.toFixed(1)] = [];
        }

        const useFinalizedOnly = document.getElementById('useFinalizedOnly').checked;
        const useExpanded = document.getElementById('useExpandedDb').checked;

        for (const p of allProblems) {
          let d = parseFloat(p.difficulty);
          if (isNaN(d)) continue;
          
          // Base requirement: manually reviewed AND has quality rating
          if (!p.manually_reviewed || !p.quality || p.quality === 0) continue;

          // Apply quality filter - this now applies to ALL modes
          if (p.quality < selectedQuality) continue;

          let includeProb = false;

          if (useFinalizedOnly) {
            // Use Finalized Only mode
            if (p.finalized) {
              includeProb = true;
            }
          } else if (useExpanded) {
            // Use Expanded Database mode: finalized OR (manually reviewed with aime_answer)
            if (p.finalized || (p.aime_answer !== null && p.aime_answer !== undefined)) {
              includeProb = true;
            }
          } else {
            // Default mode: finalized OR has aime_answer
            if (p.finalized || (p.aime_answer !== null && p.aime_answer !== undefined)) {
              includeProb = true;
            }
          }

          if (includeProb) {
            const key = (Math.round(d * 2) / 2).toFixed(1);
            if (buckets[key]) {
              buckets[key].push(p);
            }
          }
        }

        return buckets;
      }

      function sample(arr, n) {
        const copy = [...arr];
        const result = [];
        while (result.length < n && copy.length > 0) {
          const idx = Math.floor(Math.random() * copy.length);
          result.push(copy.splice(idx, 1)[0]);
        }
        return result;
      }

      function updateProblemNav() {
        const navGrid = document.getElementById('problemNavGrid');
        navGrid.innerHTML = '';
        
        for (let i = 0; i < chosenProblems.length; i++) {
          const item = document.createElement('div');
          item.className = 'problem-nav-item';
          item.textContent = i + 1;
          item.onclick = () => scrollToProblem(i);
          
          const input = document.querySelector(`input[data-index="${i}"]:not(.override)`);
          if (input && input.value.trim()) {
            item.classList.add('answered');
          }
          
          navGrid.appendChild(item);
        }
        
        document.getElementById('problemNav').style.display = chosenProblems.length > 0 ? 'block' : 'none';
      }

      function scrollToProblem(index) {
        const problemDiv = document.querySelector(`.problem[data-problem-index="${index}"]`);
        if (problemDiv) {
          problemDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
          problemDiv.classList.add('pulse');
          setTimeout(() => problemDiv.classList.remove('pulse'), 300);
          
          const input = problemDiv.querySelector('input[type="text"]');
          if (input) {
            setTimeout(() => input.focus(), 500);
          }
        }
      }

      // Handle Enter key to jump to next problem
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && e.target.tagName === 'INPUT' && e.target.type === 'text') {
          const currentIndex = parseInt(e.target.getAttribute('data-index'));
          if (!isNaN(currentIndex) && currentIndex < chosenProblems.length - 1) {
            e.preventDefault();
            scrollToProblem(currentIndex + 1);
          }
        }
      });

      // Update nav when answers change
      document.addEventListener('input', (e) => {
        if (e.target.tagName === 'INPUT' && e.target.type === 'text') {
          updateProblemNav();
        }
      });

      let currentReportProblemId = null;

      function openReportModal(problemId) {
        currentReportProblemId = problemId;
        document.getElementById('reportModal').style.display = 'block';
        document.getElementById('reportDetails').value = '';
        document.getElementById('reportType').value = 'wrong_answer';
      }

      function closeReportModal() {
        document.getElementById('reportModal').style.display = 'none';
        currentReportProblemId = null;
      }

      window.onclick = function(event) {
        const modal = document.getElementById('reportModal');
        if (event.target === modal) {
          closeReportModal();
        }
      }

      document.getElementById('submitReport').addEventListener('click', async () => {
        if (!currentReportProblemId) return;

        const submitButton = document.getElementById('submitReport');
        submitButton.disabled = true;
        submitButton.textContent = 'Submitting...';

        const reportType = document.getElementById('reportType').value;
        const details = document.getElementById('reportDetails').value.trim();

        try {
          const { error } = await supabaseClient
            .from('problem_reports')
            .insert([
              {
                problem_id: currentReportProblemId,
                report_type: reportType,
                details: details || null,
                created_at: new Date().toISOString()
              }
            ]);

          if (error) {
            console.error('Error submitting report:', error);
            alert('Failed to submit report. Please try again.');
          } else {
            alert('Thank you! Your report has been submitted.');
            closeReportModal();
          }
        } catch (err) {
          console.error('Error:', err);
          alert('Failed to submit report. Please try again.');
        } finally {
          submitButton.disabled = false;
          submitButton.textContent = 'Submit Report';
        }
      });

      function getQualityBadgeHtml(quality) {
        if (!quality || quality === 0) {
          return '<div class="quality-badge no-quality">No Rating</div>';
        }
        
        const stars = 'â˜…'.repeat(quality);
        return `<div class="quality-badge quality-${quality}">${stars} ${quality}/5</div>`;
      }

      async function replaceProblem(index) {
        const currentProblem = chosenProblems[index];
        const currentDifficulty = (Math.round(parseFloat(currentProblem.difficulty) * 2) / 2).toFixed(1);
        
        const buckets = bucketizeFine();
        const availableProblems = buckets[currentDifficulty] || [];
        
        const usedIds = new Set(chosenProblems.map(p => p.id));
        const filteredProblems = availableProblems.filter(p => !usedIds.has(p.id));
        
        if (filteredProblems.length === 0) {
          alert(`No more problems available at difficulty ${currentDifficulty}`);
          return;
        }
        
        const newProblem = filteredProblems[Math.floor(Math.random() * filteredProblems.length)];
        chosenProblems[index] = newProblem;
        
        const problemDiv = document.querySelector(`.problem[data-problem-index="${index}"]`);
        if (!problemDiv) return;
        
        problemDiv.className = "problem mathjax-process";
        problemDiv.setAttribute("data-problem-index", index);
        
        problemDiv.innerHTML = `
          ${getQualityBadgeHtml(newProblem.quality)}
          <a href="" target="_blank" class="aops-link-top" id="aops-link-${index}">View Discussion</a>
          <strong>Problem ${index + 1}:</strong>
          <span class="difficulty-indicator">Difficulty: ${parseFloat(newProblem.difficulty).toFixed(1)}</span>
          <p class="problem-text" id="problem-text-${index}"></p>
          <div class="answer"><span class="answer-label">Answer:</span> <input type="text" maxlength="3" data-index="${index}" placeholder="000" /></div>
          <div style="margin-top: 12px;">
            <button class="replace-button" onclick="replaceProblem(${index})">Replace Problem</button>
            <button class="report-button" onclick="openReportModal(${newProblem.id})">Report Issue</button>
          </div>
        `;
        
        // SECURITY FIX: Safely set content
        const problemTextEl = document.getElementById(`problem-text-${index}`);
        const aopsLinkEl = document.getElementById(`aops-link-${index}`);
        
        setMathContent(problemTextEl, newProblem.rewritten_problem || newProblem.text || '');
        aopsLinkEl.href = escapeHtml(newProblem.link || '');
        aopsLinkEl.textContent = 'View Discussion';
        
        updateProblemNav();
      }

      async function generateMock() {
        if (allProblems.length === 0) {
          alert("Problems are still loading, please wait a moment.");
          return;
        }

        const useExpanded = document.getElementById('useExpandedDb').checked;
        const level = document.getElementById("difficulty").value;

        document.getElementById("instructions").textContent = "";
        document.getElementById("summary").textContent = "";

        if (useExpanded) {
          document.getElementById("instructions").textContent =
    `Note: Using expanded database may include some problems with answers requiring modular arithmetic (mod 1000 format). Most problems will still have standard 0-999 answers.`;
        }

        const buckets = bucketizeFine();
        const plan = difficultyTemplate[level];

        let statText = "Available / Needed problems:\n";
        for (const [diff, countNeeded] of Object.entries(plan)) {
          const available = buckets[diff]?.length || 0;
          statText += `  (${diff}): ${available} / ${countNeeded}\n`;
        }
        document.getElementById("stats").innerHTML = `
          <div style="background: var(--bg-card); padding: 20px; border-radius: 12px; box-shadow: var(--shadow-sm); margin-bottom: 32px; border: 1px solid var(--border-color);">
            <details>
              <summary style="cursor: pointer; font-weight: 600; color: var(--primary-blue); font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;">Available problems by difficulty (click to expand)</summary>
              <pre style="margin-top: 15px; font-size: 14px; line-height: 1.8; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif; color: var(--text-primary);">${escapeHtml(statText)}</pre>
            </details>
          </div>
        `;

        for (const [diff, countNeeded] of Object.entries(plan)) {
          if ((buckets[diff]?.length || 0) < countNeeded) {
            document.getElementById("problems").innerHTML =
              `<p style="color:red;"><strong>Not enough problems in bucket ${diff} to generate mock.</strong></p>`;
            return;
          }
        }

        chosenProblems = [];
        for (const [diff, count] of Object.entries(plan)) {
          chosenProblems.push(...sample(buckets[diff], count));
        }

        const container = document.getElementById("problems");
        container.innerHTML = "";

        chosenProblems.forEach((p, i) => {
          const div = document.createElement("div");
          div.className = "problem mathjax-process";
          div.setAttribute("data-problem-index", i);
          div.id = `problem-${i}`;

          div.innerHTML = `
            ${getQualityBadgeHtml(p.quality)}
            <a href="" target="_blank" class="aops-link-top" id="aops-link-${i}">View Discussion</a>
            <strong>Problem ${i + 1}:</strong>
            <span class="difficulty-indicator">Difficulty: ${parseFloat(p.difficulty).toFixed(1)}</span>
            <p class="problem-text" id="problem-text-${i}"></p>
            <div class="answer"><span class="answer-label">Answer:</span> <input type="text" maxlength="3" data-index="${i}" placeholder="000" /></div>
            <div style="margin-top: 12px;">
              <button class="replace-button" onclick="replaceProblem(${i})">Replace Problem</button>
              <button class="report-button" onclick="openReportModal(${p.id})">Report Issue</button>
            </div>
          `;

          container.appendChild(div);
          
          // SECURITY FIX: Safely set content after DOM insertion
          const problemTextEl = document.getElementById(`problem-text-${i}`);
          const aopsLinkEl = document.getElementById(`aops-link-${i}`);
          
          setMathContent(problemTextEl, p.rewritten_problem || p.text || '');
          aopsLinkEl.href = escapeHtml(p.link || '');
          aopsLinkEl.textContent = 'View Discussion';
        });
        
        updateProblemNav();
      }

      let answersRevealed = false;

      function showAnswers() {
        answersRevealed = true;
        chosenProblems.forEach((p, i) => {
          const problemDiv = document.querySelector(`.problem[data-problem-index="${i}"]`);
          if (!problemDiv) return;
          
          let existingReveal = problemDiv.querySelector('.answer-reveal');
          if (existingReveal) {
            existingReveal.remove();
          }
          
          const revealDiv = document.createElement('div');
          revealDiv.className = 'answer-reveal show';
          
          let answerText = '';
          if (p.aime_answer !== null && p.aime_answer !== undefined) {
            answerText = String(p.aime_answer % 1000);
          } else if (p.answer) {
            answerText = String(p.answer);
          } else {
            answerText = 'Not available';
          }
          
          revealDiv.innerHTML = `<strong>Correct Answer:</strong> ${escapeHtml(answerText)}`;
          problemDiv.appendChild(revealDiv);
        });
      }

      async function checkAnswers() {
        let correctCount = 0;
        let results = [];

        chosenProblems.forEach((p, i) => {
          const answerInput = document.querySelector(`input[data-index="${i}"]`);
          const problemDiv = document.querySelector(`.problem[data-problem-index="${i}"]`);
          
          const existingIcon = problemDiv?.querySelector('.status-icon');
          if (existingIcon) existingIcon.remove();

          if (answerInput) {
            const userAnswer = answerInput.value.trim();
            
            if (userAnswer === '') {
              results.push({ index: i, status: 'unanswered' });
              if (problemDiv) {
                const icon = document.createElement('div');
                icon.className = 'status-icon unanswered';
                icon.textContent = 'â€“';
                problemDiv.appendChild(icon);
                setTimeout(() => icon.classList.add('show'), 50);
              }
              return;
            }
            
            let correct = false;

            if (p.aime_answer !== null && p.aime_answer !== undefined) {
              const expected = String(p.aime_answer % 1000);
              correct = userAnswer === expected;
            } else if (p.answer !== null && p.answer !== undefined) {
              correct = userAnswer === String(p.answer);
            }

            if (correct) correctCount++;
            results.push({ index: i, status: correct ? 'correct' : 'incorrect' });
            
            if (problemDiv) {
              const icon = document.createElement('div');
              icon.className = `status-icon ${correct ? 'correct' : 'incorrect'}`;
              icon.textContent = correct ? 'âœ“' : 'âœ—';
              problemDiv.appendChild(icon);
              setTimeout(() => icon.classList.add('show'), 50);
            }
          } else {
            results.push({ index: i, status: 'unanswered' });
          }
        });

        const summaryDiv = document.getElementById("summary");
        summaryDiv.innerHTML = `
          <div class="summary-header">Score: ${correctCount} / ${chosenProblems.length}</div>
          <div class="problem-grid">
            ${results.map(r => `
              <div class="problem-indicator ${r.status}" title="Problem ${r.index + 1}: ${r.status}">
                ${r.index + 1}
              </div>
            `).join('')}
          </div>
          <button class="show-answers-btn" onclick="showAnswers()">Show Answers</button>
        `;
        summaryDiv.classList.add('show');

        // Save the mock attempt if user is logged in
        if (currentUser) {
          await saveMockAttempt(correctCount, chosenProblems.length, document.getElementById("difficulty").value, chosenProblems);
        }
      }
    </script>
  </div>
</body>
</html>